name: IDAD

on:
  issues:
    types: [labeled]
  pull_request:
    types: [labeled, closed]
  issue_comment:
    types: [created]

concurrency:
  group: idad-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

env:
  MODEL_DEFAULT: ${{ vars.IDAD_MODEL_DEFAULT || 'sonnet-4.5' }}
  MODEL_PLANNER: ${{ vars.IDAD_MODEL_PLANNER || 'opus-4.5' }}
  MODEL_IMPLEMENTER: ${{ vars.IDAD_MODEL_IMPLEMENTER || 'sonnet-4.5' }}
  MODEL_REVIEWER: ${{ vars.IDAD_MODEL_REVIEWER || 'sonnet-4.5' }}
  MODEL_SECURITY: ${{ vars.IDAD_MODEL_SECURITY || 'sonnet-4.5' }}
  MODEL_DOCUMENTER: ${{ vars.IDAD_MODEL_DOCUMENTER || 'sonnet-4.5' }}
  MODEL_ISSUE_REVIEW: ${{ vars.IDAD_MODEL_ISSUE_REVIEW || 'sonnet-4.5' }}
  MODEL_IDAD: ${{ vars.IDAD_MODEL_IDAD || 'opus-4.5' }}

jobs:
  # ======================
  # ROUTER
  # ======================
  router:
    runs-on: ubuntu-latest
    outputs:
      agent: ${{ steps.route.outputs.agent }}
      model: ${{ steps.route.outputs.model }}
      issue: ${{ steps.route.outputs.issue }}
      pr: ${{ steps.route.outputs.pr }}
      skip: ${{ steps.route.outputs.skip }}
      message: ${{ steps.route.outputs.message }}
    steps:
      - id: route
        uses: actions/github-script@v7
        env:
          MODEL_DEFAULT: ${{ env.MODEL_DEFAULT }}
          MODEL_PLANNER: ${{ env.MODEL_PLANNER }}
          MODEL_IMPLEMENTER: ${{ env.MODEL_IMPLEMENTER }}
          MODEL_REVIEWER: ${{ env.MODEL_REVIEWER }}
          MODEL_SECURITY: ${{ env.MODEL_SECURITY }}
          MODEL_DOCUMENTER: ${{ env.MODEL_DOCUMENTER }}
          MODEL_ISSUE_REVIEW: ${{ env.MODEL_ISSUE_REVIEW }}
          MODEL_IDAD: ${{ env.MODEL_IDAD }}
        with:
          script: |
            const { eventName, payload } = context;
            const action = payload.action;

            // Model mapping
            const models = {
              'issue-review': process.env.MODEL_ISSUE_REVIEW,
              'planner': process.env.MODEL_PLANNER,
              'implementer': process.env.MODEL_IMPLEMENTER,
              'security-scanner': process.env.MODEL_SECURITY,
              'reviewer': process.env.MODEL_REVIEWER,
              'documenter': process.env.MODEL_DOCUMENTER,
              'idad': process.env.MODEL_IDAD,
            };

            // Label to agent mapping (only ONE idad:* label at a time)
            const labelToAgent = {
              // Issue labels
              'idad:issue-review': 'issue-review',
              'idad:planning': 'planner',
              'idad:implementing': 'implementer',
              // PR labels
              'idad:security-scan': 'security-scanner',
              'idad:code-review': 'reviewer',
              'idad:documenting': 'documenter',
            };

            // Human review states (no agent, just log)
            const humanStates = {
              'idad:issue-needs-clarification': 'â“ Issue needs clarification. Please answer the questions and comment.',
              'idad:human-plan-review': 'ðŸ“‹ Awaiting human plan review. Comment to provide feedback or approve.',
              'idad:human-pr-review': 'âœ… Ready for human review and merge.',
            };

            let agent = '';
            let issue = '';
            let pr = '';
            let skip = false;
            let message = '';

            const getLabels = (obj) => obj?.labels?.map(l => l.name) || [];
            const hasLabel = (labels, name) => labels.includes(name);

            // === ISSUE LABELED ===
            if (eventName === 'issues' && action === 'labeled') {
              const labelName = payload.label?.name || '';
              issue = String(payload.issue.number);

              if (labelToAgent[labelName]) {
                agent = labelToAgent[labelName];
              } else if (humanStates[labelName]) {
                message = humanStates[labelName];
                skip = true;
              } else {
                skip = true;
              }
            }

            // === PR LABELED ===
            else if (eventName === 'pull_request' && action === 'labeled') {
              const labelName = payload.label?.name || '';
              pr = String(payload.pull_request.number);

              if (labelToAgent[labelName]) {
                agent = labelToAgent[labelName];
              } else if (humanStates[labelName]) {
                message = humanStates[labelName];
                skip = true;
              } else {
                skip = true;
              }
            }

            // === PR MERGED (triggers IDAD agent) ===
            else if (eventName === 'pull_request' && action === 'closed') {
              const prData = payload.pull_request;
              const branch = prData.head?.ref || '';

              // Skip IDAD's own PRs (prevent loops)
              if (prData.merged && !branch.startsWith('idad/')) {
                agent = 'idad';
                pr = String(prData.number);
              } else {
                skip = true;
              }
            }

            // === COMMENT EVENTS ===
            else if (eventName === 'issue_comment' && action === 'created') {
              const commenter = payload.comment?.user?.login || '';
              const isPrComment = !!payload.issue?.pull_request;
              const labels = getLabels(payload.issue);
              const number = String(payload.issue.number);

              // Skip bot comments
              if (commenter.includes('[bot]')) {
                console.log('â­ï¸ Skipping bot comment');
                skip = true;
              }
              // Issue comment with idad:issue-needs-clarification - re-trigger issue review
              else if (!isPrComment && hasLabel(labels, 'idad:issue-needs-clarification')) {
                agent = 'issue-review';
                issue = number;
              }
              // Issue comment with idad:human-plan-review - planner processes feedback
              else if (!isPrComment && hasLabel(labels, 'idad:human-plan-review')) {
                agent = 'planner';
                issue = number;
              }
              // PR comment with idad:human-pr-review - implementer addresses feedback
              else if (isPrComment && hasLabel(labels, 'idad:human-pr-review')) {
                agent = 'implementer';
                pr = number;
              }
              else {
                skip = true;
              }
            }

            else {
              skip = true;
            }

            // Get model for agent
            const model = models[agent] || process.env.MODEL_DEFAULT;

            // Set outputs
            core.setOutput('agent', agent);
            core.setOutput('model', model);
            core.setOutput('issue', issue);
            core.setOutput('pr', pr);
            core.setOutput('skip', String(skip));
            core.setOutput('message', message);

            console.log(`ðŸš¦ Router: agent=${agent}, issue=${issue}, pr=${pr}, model=${model}, skip=${skip}`);
            if (message) console.log(`ðŸ“ ${message}`);

  # ======================
  # AGENT
  # ======================
  agent:
    needs: router
    runs-on: ubuntu-latest
    if: needs.router.outputs.skip != 'true' && needs.router.outputs.agent != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get IDAD GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.IDAD_APP_ID }}
          private-key: ${{ secrets.IDAD_APP_PRIVATE_KEY }}

      - name: Cache Cursor CLI
        id: cache-cursor
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: ${{ runner.os }}-cursor-cli-v1
          restore-keys: |
            ${{ runner.os }}-cursor-cli-

      - name: Install Cursor CLI
        if: steps.cache-cursor.outputs.cache-hit != 'true'
        run: curl -fsSL https://cursor.com/install | bash

      - name: Add Cursor to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run ${{ needs.router.outputs.agent }} agent
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          AGENT: ${{ needs.router.outputs.agent }}
          ISSUE: ${{ needs.router.outputs.issue }}
          PR: ${{ needs.router.outputs.pr }}
          MODEL: ${{ needs.router.outputs.model }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "ðŸ¤– Running $AGENT agent"
          echo "   Issue: ${ISSUE:-none}"
          echo "   PR: ${PR:-none}"
          echo "   Model: $MODEL"

          AGENT_FILE=".cursor/agents/${AGENT}.md"
          RULES_FILE=".cursor/rules/system.mdc"

          if [[ ! -f "$AGENT_FILE" ]]; then
            echo "âŒ Agent file not found: $AGENT_FILE"
            exit 1
          fi

          cursor-agent \
            ${MODEL:+--model "$MODEL"} \
            -f "$RULES_FILE" \
            -f "$AGENT_FILE" \
            -p "Execute your responsibilities now."

  # ======================
  # SUMMARY (for human states)
  # ======================
  summary:
    needs: router
    runs-on: ubuntu-latest
    if: needs.router.outputs.message != ''
    steps:
      - name: Log human review state
        run: |
          echo "${{ needs.router.outputs.message }}"
          echo "## IDAD Status" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.router.outputs.message }}" >> $GITHUB_STEP_SUMMARY
